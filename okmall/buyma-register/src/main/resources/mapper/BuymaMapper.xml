<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.buyma.repository.BuymaRepository">

    <!-- ==================== 토큰 관련 ==================== -->

    <!-- 최신 액세스 토큰 조회 -->
    <select id="selectAccessToken" resultType="string">
        SELECT access_token
        FROM buyma.buyma_tokens
        WHERE id = 1
    </select>

    <!-- 토큰 저장/업데이트 (Upsert) -->
    <insert id="upsertToken">
        INSERT INTO buyma.buyma_tokens (id, access_token, refresh_token, updated_at)
        VALUES (1, #{accessToken}, #{refreshToken}, NOW())
        ON DUPLICATE KEY UPDATE
            access_token = #{accessToken},
            refresh_token = #{refreshToken},
            updated_at = NOW()
    </insert>

    <!-- ==================== 상품 조회 관련 ==================== -->

    <!-- 등록 대상 상품 목록 조회 -->
    <select id="selectProductsToRegister" resultType="map">
        SELECT
            id,
            raw_data_id,
            reference_number,
            control,
            name,
            comments,
            brand_id,
            brand_name,
            category_id,
            price,
            available_until,
            buying_area_id,
            shipping_area_id,
            buying_shop_name,
            model_no,
            theme_id,
            duty
        FROM buyma.ace_products
        WHERE is_published = 0
          AND control = 'publish'
          AND category_id > 0
        ORDER BY id ASC
        <if test="limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 등록 대상 상품 총 수 조회 -->
    <select id="countProductsToRegister" resultType="int">
        SELECT COUNT(*)
        FROM buyma.ace_products
        WHERE is_published = 0
          AND control = 'publish'
          AND category_id > 0
    </select>

    <!-- 특정 상품 조회 -->
    <select id="selectProductById" resultType="map">
        SELECT
            id,
            raw_data_id,
            reference_number,
            control,
            name,
            comments,
            brand_id,
            brand_name,
            category_id,
            price,
            available_until,
            buying_area_id,
            shipping_area_id,
            buying_shop_name,
            model_no,
            theme_id,
            duty,
            is_published
        FROM buyma.ace_products
        WHERE id = #{aceProductId}
    </select>

    <!-- 상품 이미지 조회 (cloudflare_image_url 우선) -->
    <select id="selectProductImages" resultType="map">
        SELECT
            id,
            position,
            COALESCE(NULLIF(cloudflare_image_url, ''), source_image_url) AS image_url
        FROM buyma.ace_product_images
        WHERE ace_product_id = #{aceProductId}
        ORDER BY position ASC
    </select>

    <!-- 상품 옵션 조회 (color, size) -->
    <select id="selectProductOptions" resultType="map">
        SELECT
            id,
            option_type AS type,
            value,
            master_id,
            position
        FROM buyma.ace_product_options
        WHERE ace_product_id = #{aceProductId}
        ORDER BY option_type, position ASC
    </select>

    <!-- 상품 재고(variants) 조회 -->
    <select id="selectProductVariants" resultType="map">
        SELECT
            id,
            color_value,
            size_value,
            options_json,
            stock_type,
            stocks
        FROM buyma.ace_product_variants
        WHERE ace_product_id = #{aceProductId}
        ORDER BY id ASC
    </select>

    <!-- 배송 방법 조회 -->
    <select id="selectShippingMethods" resultType="int">
        SELECT shipping_method_id
        FROM buyma.ace_product_shipping
        WHERE ace_product_id = #{aceProductId}
    </select>

    <!-- ==================== 상품 업데이트 관련 ==================== -->

    <!-- 상품 등록 성공 시 업데이트 -->
    <update id="updateProductRegistered">
        UPDATE buyma.ace_products
        SET
            is_published = 1,
            api_request_json = #{requestJson},
            last_api_call_at = NOW(),
            updated_at = NOW()
        WHERE id = #{aceProductId}
    </update>

    <!-- 상품 등록 실패 시 업데이트 -->
    <update id="updateProductFailed">
        UPDATE buyma.ace_products
        SET
            api_request_json = #{requestJson},
            api_response_json = CONCAT('{"error": "', REPLACE(#{errorMessage}, '"', '\\"'), '"}'),
            last_api_call_at = NOW(),
            updated_at = NOW()
        WHERE id = #{aceProductId}
    </update>

    <!-- 웹훅 결과 업데이트 -->
    <update id="updateWebhookResult">
        UPDATE buyma.ace_products
        SET
            buyma_product_id = #{buymaProductId},
            <choose>
                <when test="status == 'SUCCESS'">
                    is_published = 1,
                </when>
                <otherwise>
                    api_response_json = CONCAT('{"webhook_error": "', REPLACE(#{errorMsg}, '"', '\\"'), '"}'),
                </otherwise>
            </choose>
            updated_at = NOW()
        WHERE reference_number = #{refNum}
    </update>

    <!-- ==================== API 로그 관련 ==================== -->

    <!-- API 호출 로그 저장 -->
    <insert id="insertApiCallLog">
        INSERT INTO buyma.api_call_logs (
            api_type,
            api_action,
            ace_product_id,
            request_json,
            response_json,
            http_status_code,
            request_uid,
            is_success,
            error_message,
            created_at
        ) VALUES (
            #{apiType},
            #{apiAction},
            #{aceProductId},
            #{requestJson},
            #{responseJson},
            #{httpStatusCode},
            #{requestUid},
            #{isSuccess},
            #{errorMessage},
            NOW()
        )
    </insert>

</mapper>
