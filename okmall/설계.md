# BUYMA 자동화 파이프라인 시스템 설계서

본 문서는 쇼핑몰 상품 수집부터 바이마 등록까지의 전 과정을 자동화하기 위한 시스템 설계 내용을 담고 있습니다.

---

## 1. 비개발자용 설명 (스마트 자동화 공장 비유)

이 시스템은 사람이 일일이 하던 작업을 **"버튼 하나로 돌아가는 스마트 공장"**으로 만드는 프로젝트입니다.

### 공장의 5단계 컨베이어 벨트
1. **[1구역: 재료 수집] (COLLECT)**: 쇼핑몰(오케이몰 등)에서 상품 정보를 긁어오는 단계 (원재료 확보)
2. **[2구역: 재료 다듬기] (CONVERT)**: 정보를 정리하고 일본어로 번역하는 단계 (상품화 준비)
3. **[3구역: 사진 촬영 및 저장] (IMAGE)**: 상품 사진을 우리 전용 창고(R2)에 저장하는 단계 (화보 준비)
4. **[4구역: 시장 조사] (PRICE)**: 바이마 내 최저가를 확인하여 판매가를 참고하는 단계 (가격 경쟁력 확보)
5. **[5구역: 매장 진열] (REGISTER)**: 준비된 모든 정보를 바이마 매장에 최종 등록하는 단계 (판매 시작)

### 투트랙(Two-Track) 운영 전략
| 모드 | 주기 | 목적 | 단계 |
|------|------|------|------|
| **FULL** | 하루 1번 (새벽) | 신상 수집 + 전체 동기화 | COLLECT → CONVERT → IMAGE → PRICE → REGISTER |
| **PARTIAL** | 매시간 | 재고/가격 빠른 체크 | COLLECT → ~~CONVERT~~ → ~~IMAGE~~ → PRICE → REGISTER |

> PARTIAL 모드에서는 CONVERT, IMAGE 단계가 자동 스킵됩니다 (이미 처리된 상품만 대상)

### 시스템의 장점
* **자동 복구**: 정전 등으로 공장이 멈춰도, 다시 가동하면 멈췄던 브랜드의 멈췄던 단계부터 알아서 다시 시작합니다.
* **효율성**: 똑같은 사진을 두 번 찍거나 이미 등록한 상품을 중복해서 작업하지 않습니다.
* **확장성**: 새로운 쇼핑몰 추가 시 COLLECT 워커만 추가하면 됩니다.

---

## 2. 개발자용 설계 (Technical Architecture)

### 시스템 구조
```
┌─────────────────────────────────────────────────────────────┐
│                    Orchestrator (코어 실행기)                 │
│  - 배치 생성/관리                                             │
│  - 워커 호출 및 상태 추적                                      │
│  - 에러 핸들링 및 복구                                        │
└─────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│ COLLECT │ CONVERT │  IMAGE  │  PRICE  │REGISTER │
│  Worker │  Worker │  Worker │  Worker │  Worker │
└─────────┴─────────┴─────────┴─────────┴─────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                   MariaDB (State Store)                      │
│  - pipeline_batches (실행 이력)                               │
│  - pipeline_control (단계별 상태)                             │
│  - raw_scraped_data, ace_products, ace_product_images 등      │
└─────────────────────────────────────────────────────────────┘
```

### 데이터베이스 설계 (State Management)

#### `pipeline_batches` (실행 이력 관리)
전체 공장 가동 단위의 로그를 기록합니다.

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INT | PK, Auto Increment |
| batch_id | VARCHAR(50) | 실행 식별자 (예: 20260127_01) |
| run_mode | ENUM | FULL / PARTIAL |
| status | ENUM | RUNNING / COMPLETED / FAILED |
| start_time | DATETIME | 배치 시작 시간 |
| end_time | DATETIME | 배치 종료 시간 |
| total_brands | INT | 처리 대상 브랜드 총수 |
| success_brands | INT | 성공한 브랜드 수 (진척도 표시용) |

#### `pipeline_control` (단계별 상태 관리)
브랜드별, 공정별 세부 진행 상태를 추적합니다.

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | INT | PK, Auto Increment |
| batch_id | VARCHAR(50) | FK → pipeline_batches |
| mall_name | VARCHAR(50) | 쇼핑몰 (okmall, wconcept 등) |
| brand_name | VARCHAR(100) | 브랜드명 |
| run_mode | ENUM | FULL / PARTIAL (조회 편의용) |
| stage | ENUM | COLLECT / CONVERT / IMAGE / PRICE / REGISTER |
| status | ENUM | PENDING / RUNNING / DONE / ERROR |
| item_count | INT | 해당 단계에서 처리된 아이템 수 |
| error_msg | TEXT | 실패 시 에러 메시지 |
| started_at | DATETIME | 단계 시작 시간 (성능 분석용) |
| updated_at | DATETIME | 마지막 업데이트 시간 |

### 핵심 로직

#### 1. 멱등성 (Idempotency)
모든 데이터 처리는 `INSERT ... ON DUPLICATE KEY UPDATE` 구문을 사용하여 중복 실행 시에도 데이터 일관성을 유지합니다.

#### 2. 재시작 로직 (Checkpoint Recovery)
```
실행기 시작
    │
    ▼
pipeline_batches에서 status='RUNNING'인 batch_id 조회
    │
    ├─ 있음 → 해당 batch_id 이어서 진행
    │         (pipeline_control에서 status != 'DONE'인 단계부터)
    │
    └─ 없음 → 새 batch_id 생성 후 처음부터 시작
```

#### 3. PARTIAL 모드 스킵 로직
```
PARTIAL 모드 실행 시:
  - COLLECT: 가격/재고 정보만 수집 (신규 상품 X)
  - CONVERT: 스킵 (이미 변환된 상품만 대상)
  - IMAGE: 스킵 (이미 이미지 있음)
  - PRICE: 최저가 수집
  - REGISTER: 바이마 업데이트
```

---

## 3. SQL DDL (테이블 생성문)

```sql
-- =====================================================
-- 파이프라인 상태 관리 테이블
-- =====================================================

-- 1. pipeline_batches (실행 이력 관리)
CREATE TABLE pipeline_batches (
    id INT AUTO_INCREMENT PRIMARY KEY,
    batch_id VARCHAR(50) NOT NULL,
    run_mode ENUM('FULL', 'PARTIAL') NOT NULL,
    status ENUM('RUNNING', 'COMPLETED', 'FAILED') DEFAULT 'RUNNING',
    start_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    end_time DATETIME NULL,
    total_brands INT DEFAULT 0,
    success_brands INT DEFAULT 0,

    UNIQUE KEY uk_batch_id (batch_id),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='파이프라인 배치 실행 이력';


-- 2. pipeline_control (단계별 상태 관리)
CREATE TABLE pipeline_control (
    id INT AUTO_INCREMENT PRIMARY KEY,
    batch_id VARCHAR(50) NOT NULL,
    mall_name VARCHAR(50) NOT NULL,
    brand_name VARCHAR(100) NOT NULL,
    run_mode ENUM('FULL', 'PARTIAL') NOT NULL,
    stage ENUM('COLLECT', 'CONVERT', 'IMAGE', 'PRICE', 'REGISTER') NOT NULL,
    status ENUM('PENDING', 'RUNNING', 'DONE', 'ERROR') DEFAULT 'PENDING',
    item_count INT DEFAULT 0,
    error_msg TEXT NULL,
    started_at DATETIME NULL,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_batch_brand_stage (batch_id, mall_name, brand_name, stage),
    INDEX idx_batch_id (batch_id),
    INDEX idx_status (status),
    INDEX idx_mall_brand (mall_name, brand_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='파이프라인 브랜드별 단계 상태';
```

---

## 4. 향후 로드맵

### Step 1: 기반 구축
- [x] 설계 문서 작성
- [ ] 상태 관리 테이블 생성 (SQL 실행)
- [ ] 코어 실행기 (Orchestrator) 기초 골격 구현

### Step 2: 워커 통합
- [ ] 기존 스크립트들을 워커 모듈 형태로 래핑
  - okmall_all_brands_collector.py → COLLECT Worker
  - raw_to_ace_converter.py → CONVERT Worker
  - image_collector_parallel.py → IMAGE Worker (수집)
  - r2_image_uploader.py → IMAGE Worker (업로드)
  - buyma_lowest_price_collector.py → PRICE Worker
  - buyma_product_register.py → REGISTER Worker

### Step 3: 운영 자동화
- [ ] 에러 알림 시스템 (Slack/Email) 연동
- [ ] 스케줄러 (Cron) 등록
  - FULL 모드: 매일 03:00
  - PARTIAL 모드: 매시간 정각

---

## 5. 참고: 기존 테이블과의 관계

```
[파이프라인 상태]              [비즈니스 데이터]
pipeline_batches              mall_brands (브랜드 마스터)
       │                            │
       ▼                            ▼
pipeline_control ───────────→ raw_scraped_data (COLLECT)
                                    │
                                    ▼
                              ace_products (CONVERT)
                                    │
                                    ▼
                              ace_product_images (IMAGE)
                                    │
                                    ▼
                              buyma_lowest_prices (PRICE)
                                    │
                                    ▼
                              바이마 API (REGISTER)
```
